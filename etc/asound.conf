## ------------------------------------------------------------------
## IMPORTANT :: This file is useful for system wide alsa configuration.
##       You also need to load some kernel modules and using a
##       tiny qjackctl script. You may find the files needed here
##       in the repository, too.
##
##       This configuration works best if your Linux system is
##       ready and configured for Realtime Audio.
#
##       This configuration still contains configuration errors which
##       is probably due to mixing more than one websources.
## + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
## Some time ago there was a file /etc/alsa.conf. This file
## isn't used anymore and will be ignored. If alsa.conf is present
## it can be deleted. Better and more secure is to 
## use the user's .asoundrc file.
## ------------------------------------------------------------------

## -------------------
## DEBUG ONLY - BEGIN
## -------------------
# Probably not usable when loopback functionality is used.
# Keep it off if everything works as expected.
#pcm.!default {
#    type hw
#    card PCH
#}
#ctl.!default {
#    type hw
#    card PCH
#}
## -------------------
## DEBUG ONLY - END
## -------------------





# +++++++++++++++++++   ALSA Jack Loopback configuration   +++++++++++++++++++ #
#                                                                              #
# With the help of Marc's great tutorial at                                    #
#    https://alsa.opensrc.org/Jack_and_Loopback_device_as_Alsa-to-Jack_bridge  #
# and some aspects from LinuxMusian's forum:                                   #
#    https://linuxmusicians.com/viewtopic.php?t=16358                          #
# ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #
# * ALSA playback = subdevice 0,0
# * ALSA capture  = subdevice 0,1 
# * Jack readable client (cloop) = subdevice 1,0
# * Jack writable client (ploop) = subdevice 1,1
# ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

# # hardware 0,0 : used for ALSA playback
pcm.loophw00 {
  type hw
  card Loopback
  device 0
  subdevice 0
  format S16_LE
  rate 48000
}

# # hardware 0,1 : used for ALSA capture
pcm.loophw01 {
  type hw
  card Loopback
  device 0
  subdevice 1
  format S16_LE
  rate 48000
}

# # for jack alsa_in: looped-back signal at other ends
pcm.cloop {
  type hw
  card Loopback
  device 1
  subdevice 0
  format S16_LE
  rate 48000
}

# # for jack alsa_out: looped-back signal at other end
pcm.ploop {
  type hw
  card Loopback
  device 1
  subdevice 1
  format S16_LE
  rate 48000
}

# # Creata the ALSA Loop bridge with
# capture client
#    alsa_in -j cloop -dcloop
# playback client
#    alsa_out -j ploop -dploop 



## Volume mixing
pcm.asoftvol {
    type            softvol
    slave.pcm       "amix"
    control { name PCM }

    min_dB -35.0
    max_dB 10.0
    resolution 90
}




# # playback PCM device: using loopback subdevice 0,0
#     Don't use a buffer size that is too small. Some apps 
#     won't like it and it will sound crappy 
#     putting period/buffer size here will cause some youtube videos to be silent
pcm.amix {
  type dmix
  ipc_key 219345
  slave {
    pcm "hw:Loopback,0,0"
    period_size 4096
    periods 2
  }
}

# # capture PCM device: using loopback subdevice 0,1
#     don't use braces for the slave device otherwise it won't work
pcm.asnoop {
  type dsnoop
  ipc_key 219346
  slave.pcm "loophw01"
}

# # duplex device combining our PCM devices defined above
pcm.aduplex {
  type asym
  playback.pcm "amix"
  capture.pcm "asnoop"
}


# # period/buffer size might not even do anything here except
#    add delay, I can't tell... make sure youtube videos aren't too desyncronised
# START :: grepped from https://linuxmusicians.com/viewtopic.php?t=16358
pcm.bridge_out {
  type dsnoop
  ipc_key 219348
  slave {
    pcm "hw:Loopback,1,0"
    format S32_LE
    rate 48000
    period_size 4096
    buffer_size 8192
  }
}
# # the braces thing probably applies here too
pcm.bridge_in {
  type plug
  slave.pcm "hw:Loopback,1,1"
}
# END :: grepped from https://linuxmusicians.com/viewtopic.php?t=16358


# # default device
#    if changing this file, keep an eye on whether audacity still 
#    has a "default" option that works
pcm.!default {
  type plug
  slave.pcm aduplex
  hint {
       show on
       description "Duplex Loopback"
  }
}
# # apparently some programs look for card0 instead of default
pcm.card0 {
  type plug
  slave.pcm "aduplex"
}

# # apparently some programs look for a corresponding ctl device so 
#    we might as well let them find one
ctl.aduplex {
  type hw
  card 0
}
ctl.!default {
  type hw
  card 0
}
ctl.card0 {
  type hw
  card 0
}


